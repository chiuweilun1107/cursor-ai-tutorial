---
description: 
globs: 
alwaysApply: true
---
# OWASP Top 10 å®‰å…¨è¦ç¯„ - CursorLearning Platform

## ğŸ” æ ¸å¿ƒå®‰å…¨åŸå‰‡

åŸºæ–¼ OWASP Top 10 å’Œæœ€ä½³å¯¦è¸ï¼Œæœ¬æ–‡æª”å®šç¾©äº†å‰ç«¯æ‡‰ç”¨ç¨‹å¼çš„å®‰å…¨é–‹ç™¼è¦ç¯„ã€‚

## ğŸ“Š OWASP Top 10 2021 å°æ‡‰æªæ–½

### **A01:2021 â€“ å­˜å–æ§åˆ¶å¤±æ•ˆ (Broken Access Control)**

#### **å‰ç«¯é˜²è­·æªæ–½**
```typescript
// âœ… æ­£ç¢ºçš„è·¯ç”±ä¿è­·
import { Navigate } from 'react-router-dom';

const ProtectedRoute: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const { user, isAuthenticated } = useAuth();
  
  if (!isAuthenticated) {
    return <Navigate to="/login" replace />;
  }
  
  return <>{children}</>;
};

// âœ… è§’è‰²åŸºç¤å­˜å–æ§åˆ¶
const AdminRoute: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const { user } = useAuth();
  
  if (!user?.roles?.includes('admin')) {
    return <Navigate to="/unauthorized" replace />;
  }
  
  return <>{children}</>;
};
```

#### **API å‘¼å«å®‰å…¨**
```typescript
// âœ… å®‰å…¨çš„ API è«‹æ±‚
const apiClient = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL,
  timeout: 10000,
});

// è‡ªå‹•é™„åŠ èªè­‰ Token
apiClient.interceptors.request.use((config) => {
  const token = localStorage.getItem('authToken');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// è™•ç†èªè­‰å¤±æ•ˆ
apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      // æ¸…é™¤æœ¬åœ°èªè­‰è³‡è¨Šä¸¦é‡å®šå‘
      localStorage.removeItem('authToken');
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);
```

### **A02:2021 â€“ åŠ å¯†å¤±æ•ˆ (Cryptographic Failures)**

#### **æ•æ„Ÿè³‡æ–™è™•ç†**
```typescript
// âœ… æ­£ç¢ºçš„æ•æ„Ÿè³‡æ–™è™•ç†
class SecureStorage {
  private static readonly ENCRYPTION_KEY = 'your-secret-key';
  
  // é¿å…åœ¨ localStorage å­˜å„²æ•æ„Ÿè³‡æ–™
  static setSecureItem(key: string, value: string): void {
    // ä½¿ç”¨ sessionStorage è€Œé localStorage å­˜å„²æ•æ„Ÿè³‡æ–™
    sessionStorage.setItem(key, btoa(value)); // åŸºæœ¬ç·¨ç¢¼ï¼Œå¯¦éš›æ‡‰ä½¿ç”¨æ›´å¼·çš„åŠ å¯†
  }
  
  static getSecureItem(key: string): string | null {
    const encoded = sessionStorage.getItem(key);
    return encoded ? atob(encoded) : null;
  }
  
  static removeSecureItem(key: string): void {
    sessionStorage.removeItem(key);
  }
}

// âŒ éŒ¯èª¤ç¤ºä¾‹ï¼šæ˜æ–‡å­˜å„²æ•æ„Ÿè³‡æ–™
// localStorage.setItem('token', 'my-secret-token'); // ä¸å®‰å…¨ï¼
```

#### **HTTPS å¼·åˆ¶ä½¿ç”¨**
```typescript
// âœ… ç¢ºä¿ HTTPS é€£æ¥
const ensureHTTPS = () => {
  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    location.replace(`https:${location.href.substring(location.protocol.length)}`);
  }
};

// åœ¨æ‡‰ç”¨åˆå§‹åŒ–æ™‚æª¢æŸ¥
export const App: React.FC = () => {
  useEffect(() => {
    ensureHTTPS();
  }, []);
  
  return <Router>{/* æ‡‰ç”¨å…§å®¹ */}</Router>;
};
```

### **A03:2021 â€“ æ³¨å…¥æ”»æ“Š (Injection)**

#### **XSS é˜²è­·**
```typescript
// âœ… æ­£ç¢ºçš„è¼¸å‡ºè™•ç†
import DOMPurify from 'dompurify';

const SafeHtmlRenderer: React.FC<{ content: string }> = ({ content }) => {
  const sanitizedContent = DOMPurify.sanitize(content, {
    SANITIZE_NAMED_PROPS: true, // é˜²è­· DOM Clobbering
    ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'ul', 'ol', 'li'],
    ALLOWED_ATTR: ['href', 'title']
  });
  
  return <div dangerouslySetInnerHTML={{ __html: sanitizedContent }} />;
};

// âœ… å®‰å…¨çš„ç”¨æˆ¶è¼¸å…¥è™•ç†
const UserComment: React.FC<{ comment: string }> = ({ comment }) => {
  // ä½¿ç”¨ textContent è€Œé innerHTML
  return <p>{comment}</p>; // React è‡ªå‹•è½‰ç¾©
};
```

#### **SQL æ³¨å…¥é˜²è­·ï¼ˆå¾Œç«¯ API å‘¼å«ï¼‰**
```typescript
// âœ… åƒæ•¸åŒ–æŸ¥è©¢ï¼ˆå‰ç«¯é©—è­‰ï¼‰
const searchCourses = async (query: string) => {
  // å‰ç«¯è¼¸å…¥é©—è­‰
  if (!query || query.length > 100) {
    throw new Error('Invalid search query');
  }
  
  // ä½¿ç”¨ URL åƒæ•¸è€Œéå­—ä¸²æ‹¼æ¥
  const response = await apiClient.get('/courses/search', {
    params: { q: query } // axios æœƒè‡ªå‹•ç·¨ç¢¼åƒæ•¸
  });
  
  return response.data;
};
```

### **A04:2021 â€“ ä¸å®‰å…¨è¨­è¨ˆ (Insecure Design)**

#### **å®‰å…¨çš„è¡¨å–®è¨­è¨ˆ**
```typescript
// âœ… å®‰å…¨çš„è¡¨å–®é©—è­‰
const LoginForm: React.FC = () => {
  const [formData, setFormData] = useState({ email: '', password: '' });
  const [errors, setErrors] = useState<Record<string, string>>({});
  
  const validateForm = (data: typeof formData): Record<string, string> => {
    const errors: Record<string, string> = {};
    
    // Email é©—è­‰
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(data.email)) {
      errors.email = 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€';
    }
    
    // å¯†ç¢¼å¼·åº¦æª¢æŸ¥
    if (data.password.length < 8) {
      errors.password = 'å¯†ç¢¼è‡³å°‘éœ€è¦ 8 å€‹å­—ç¬¦';
    }
    
    return errors;
  };
  
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    const validationErrors = validateForm(formData);
    if (Object.keys(validationErrors).length > 0) {
      setErrors(validationErrors);
      return;
    }
    
    try {
      await login(formData);
    } catch (error) {
      // ä¸é€éœ²å…·é«”éŒ¯èª¤è³‡è¨Š
      setErrors({ general: 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„æ†‘è­‰' });
    }
  };
  
  return (
    <form onSubmit={handleSubmit}>
      {/* è¡¨å–®æ¬„ä½ */}
    </form>
  );
};
```

### **A05:2021 â€“ å®‰å…¨è¨­å®šéŒ¯èª¤ (Security Misconfiguration)**

#### **Content Security Policy (CSP)**
```html
<!-- âœ… åœ¨ index.html ä¸­è¨­å®š CSP -->
<meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; 
               script-src 'self' 'unsafe-inline' https://trusted-scripts.com; 
               style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
               font-src 'self' https://fonts.gstatic.com;
               img-src 'self' data: https:;
               connect-src 'self' https://api.example.com;">
```

#### **å®‰å…¨æ¨™é ­è¨­å®š**
```typescript
// âœ… Vite é…ç½®ä¸­çš„å®‰å…¨æ¨™é ­
export default defineConfig({
  server: {
    headers: {
      'X-Content-Type-Options': 'nosniff',
      'X-Frame-Options': 'DENY',
      'X-XSS-Protection': '1; mode=block',
      'Referrer-Policy': 'strict-origin-when-cross-origin'
    }
  }
});
```

### **A06:2021 â€“ æ˜“å—æ”»æ“Šå’Œéæ™‚çš„å…ƒä»¶ (Vulnerable and Outdated Components)**

#### **ä¾è³´ç®¡ç†**
```bash
# âœ… å®šæœŸæª¢æŸ¥å®‰å…¨æ¼æ´
npm audit

# âœ… ä¿®å¾©å·²çŸ¥æ¼æ´
npm audit fix

# âœ… ä½¿ç”¨ npm-check-updates æª¢æŸ¥éæ™‚ä¾è³´
npx npm-check-updates -u
```

#### **ä¾è³´å®‰å…¨ç›£æ§**
```json
// package.json ä¸­çš„å®‰å…¨è…³æœ¬
{
  "scripts": {
    "security-check": "npm audit && npm run build",
    "deps-update": "npx npm-check-updates -u && npm install",
    "security-report": "npm audit --json > security-report.json"
  }
}
```

### **A07:2021 â€“ è­˜åˆ¥å’Œèªè­‰å¤±æ•ˆ (Identification and Authentication Failures)**

#### **å®‰å…¨çš„èªè­‰è™•ç†**
```typescript
// âœ… å®‰å…¨çš„å¯†ç¢¼è™•ç†
const PasswordInput: React.FC<{ onChange: (value: string) => void }> = ({ onChange }) => {
  const [showPassword, setShowPassword] = useState(false);
  
  return (
    <div className="relative">
      <input
        type={showPassword ? "text" : "password"}
        autoComplete="current-password" // é‡è¦ï¼šå…è¨±å¯†ç¢¼ç®¡ç†å™¨å·¥ä½œ
        onChange={(e) => onChange(e.target.value)}
        className="w-full px-3 py-2 border rounded-md"
      />
      <button
        type="button"
        onClick={() => setShowPassword(!showPassword)}
        className="absolute right-2 top-2"
      >
        {showPassword ? 'éš±è—' : 'é¡¯ç¤º'}
      </button>
    </div>
  );
};

// âœ… å¤šå› ç´ èªè­‰æ”¯æ´
const MFASetup: React.FC = () => {
  const [qrCode, setQrCode] = useState<string>('');
  
  const enableMFA = async () => {
    try {
      const response = await apiClient.post('/auth/mfa/setup');
      setQrCode(response.data.qrCode);
    } catch (error) {
      console.error('MFA setup failed:', error);
    }
  };
  
  return (
    <div>
      <button onClick={enableMFA}>å•Ÿç”¨é›™å› ç´ èªè­‰</button>
      {qrCode && <img src={qrCode} alt="MFA QR Code" />}
    </div>
  );
};
```

### **A08:2021 â€“ è»Ÿé«”å’Œè³‡æ–™å®Œæ•´æ€§å¤±æ•ˆ (Software and Data Integrity Failures)**

#### **å®Œæ•´æ€§é©—è­‰**
```typescript
// âœ… æª”æ¡ˆä¸Šå‚³å®Œæ•´æ€§æª¢æŸ¥
const FileUpload: React.FC = () => {
  const validateFile = (file: File): boolean => {
    // æª”æ¡ˆé¡å‹é©—è­‰
    const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];
    if (!allowedTypes.includes(file.type)) {
      return false;
    }
    
    // æª”æ¡ˆå¤§å°é™åˆ¶
    const maxSize = 5 * 1024 * 1024; // 5MB
    if (file.size > maxSize) {
      return false;
    }
    
    return true;
  };
  
  const handleFileUpload = async (file: File) => {
    if (!validateFile(file)) {
      throw new Error('æª”æ¡ˆé©—è­‰å¤±æ•—');
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    // ä½¿ç”¨ multipart/form-data ä¸Šå‚³
    await apiClient.post('/upload', formData, {
      headers: { 'Content-Type': 'multipart/form-data' }
    });
  };
  
  return <input type="file" onChange={(e) => e.target.files?.[0] && handleFileUpload(e.target.files[0])} />;
};
```

### **A09:2021 â€“ å®‰å…¨è¨˜éŒ„å’Œç›£æ§å¤±æ•ˆ (Security Logging and Monitoring Failures)**

#### **å‰ç«¯éŒ¯èª¤ç›£æ§**
```typescript
// âœ… å®‰å…¨äº‹ä»¶è¨˜éŒ„
class SecurityLogger {
  static logSecurityEvent(event: string, details?: any) {
    const logData = {
      timestamp: new Date().toISOString(),
      event,
      details,
      userAgent: navigator.userAgent,
      url: window.location.href
    };
    
    // ç™¼é€åˆ°å¾Œç«¯å®‰å…¨ç›£æ§ç³»çµ±
    apiClient.post('/security/log', logData).catch(() => {
      // éœé»˜å¤±æ•—ï¼Œé¿å…å½±éŸ¿ç”¨æˆ¶é«”é©—
    });
  }
  
  static logFailedLogin(email: string) {
    this.logSecurityEvent('failed_login', { email });
  }
  
  static logSuspiciousActivity(activity: string) {
    this.logSecurityEvent('suspicious_activity', { activity });
  }
}

// ä½¿ç”¨ç¯„ä¾‹
const handleLogin = async (credentials: LoginCredentials) => {
  try {
    await login(credentials);
  } catch (error) {
    SecurityLogger.logFailedLogin(credentials.email);
    throw error;
  }
};
```

### **A10:2021 â€“ ä¼ºæœå™¨ç«¯è«‹æ±‚å½é€  (Server Side Request Forgery)**

#### **å‰ç«¯ URL é©—è­‰**
```typescript
// âœ… URL å®‰å…¨é©—è­‰
const validateUrl = (url: string): boolean => {
  try {
    const urlObj = new URL(url);
    
    // åªå…è¨± HTTPS å’Œ HTTP å”è­°
    if (!['http:', 'https:'].includes(urlObj.protocol)) {
      return false;
    }
    
    // ç¦æ­¢æœ¬åœ°å’Œç§æœ‰ IP åœ°å€
    const hostname = urlObj.hostname;
    const forbiddenHosts = [
      'localhost',
      '127.0.0.1',
      '0.0.0.0',
      '::1'
    ];
    
    if (forbiddenHosts.includes(hostname)) {
      return false;
    }
    
    // æª¢æŸ¥ç§æœ‰ IP ç¯„åœ
    if (hostname.match(/^10\./) || 
        hostname.match(/^192\.168\./) || 
        hostname.match(/^172\.(1[6-9]|2[0-9]|3[0-1])\./)) {
      return false;
    }
    
    return true;
  } catch {
    return false;
  }
};

// âœ… å®‰å…¨çš„å¤–éƒ¨è³‡æºè¼‰å…¥
const ExternalImageLoader: React.FC<{ src: string }> = ({ src }) => {
  const [isValidUrl, setIsValidUrl] = useState(false);
  
  useEffect(() => {
    setIsValidUrl(validateUrl(src));
  }, [src]);
  
  if (!isValidUrl) {
    return <div>ç„¡æ•ˆçš„åœ–ç‰‡ä¾†æº</div>;
  }
  
  return <img src={src} alt="å¤–éƒ¨åœ–ç‰‡" />;
};
```

## ğŸ›¡ï¸ é¡å¤–å®‰å…¨æªæ–½

### **è·¨ç«™è«‹æ±‚å½é€  (CSRF) é˜²è­·**
```typescript
// âœ… CSRF Token è™•ç†
const CSRFProtection = () => {
  const [csrfToken, setCsrfToken] = useState<string>('');
  
  useEffect(() => {
    // å¾ meta tag ç²å– CSRF token
    const token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    if (token) {
      setCsrfToken(token);
      // è¨­å®š axios é è¨­æ¨™é ­
      apiClient.defaults.headers.common['X-CSRF-TOKEN'] = token;
    }
  }, []);
  
  return null;
};
```

### **é»æ“ŠåŠ«æŒé˜²è­·**
```typescript
// âœ… Frame busting æŠ€è¡“
const FrameBustingProtection = () => {
  useEffect(() => {
    // æª¢æŸ¥æ˜¯å¦åœ¨ iframe ä¸­é‹è¡Œ
    if (window.top !== window.self) {
      // å˜—è©¦è·³å‡º iframe
      window.top!.location = window.self.location;
    }
  }, []);
  
  return null;
};
```

## ğŸ“ å®‰å…¨é–‹ç™¼æª¢æŸ¥æ¸…å–®

### **é–‹ç™¼éšæ®µ**
- [ ] æ‰€æœ‰ç”¨æˆ¶è¼¸å…¥éƒ½ç¶“éé©—è­‰å’Œæ¸…ç†
- [ ] ä½¿ç”¨ HTTPS é€²è¡Œæ‰€æœ‰é€šä¿¡
- [ ] å¯¦æ–½é©ç•¶çš„èªè­‰å’Œæˆæ¬Š
- [ ] è¨­å®š Content Security Policy
- [ ] é¿å…åœ¨å®¢æˆ¶ç«¯å­˜å„²æ•æ„Ÿè³‡æ–™
- [ ] ä½¿ç”¨å®‰å…¨çš„ HTTP æ¨™é ­
- [ ] å®šæœŸæ›´æ–°ä¾è³´å¥—ä»¶

### **æ¸¬è©¦éšæ®µ**
- [ ] åŸ·è¡Œ `npm audit` æª¢æŸ¥æ¼æ´
- [ ] æ¸¬è©¦å„ç¨®è¼¸å…¥çµ„åˆ
- [ ] é©—è­‰èªè­‰æµç¨‹
- [ ] æª¢æŸ¥éŒ¯èª¤è™•ç†
- [ ] æ¸¬è©¦è·¨ç«™è…³æœ¬æ”»æ“Šé˜²è­·

### **éƒ¨ç½²å‰**
- [ ] ç§»é™¤æ‰€æœ‰èª¿è©¦ç¨‹å¼ç¢¼
- [ ] ç¢ºèªç”Ÿç”¢ç’°å¢ƒé…ç½®
- [ ] æª¢æŸ¥ç’°å¢ƒè®Šæ•¸å®‰å…¨æ€§
- [ ] é©—è­‰ CSP æ”¿ç­–
- [ ] ç¢ºèªæ—¥èªŒè¨˜éŒ„æ­£å¸¸é‹ä½œ

## ğŸš¨ äº‹ä»¶å›æ‡‰ç¨‹åº

```typescript
// âœ… å®‰å…¨äº‹ä»¶å›æ‡‰
const SecurityIncidentHandler = {
  handleSuspiciousActivity: () => {
    // 1. è¨˜éŒ„äº‹ä»¶
    SecurityLogger.logSuspiciousActivity('å¤šæ¬¡ç™»å…¥å¤±æ•—');
    
    // 2. é€šçŸ¥ç”¨æˆ¶
    alert('æª¢æ¸¬åˆ°å¯ç–‘æ´»å‹•ï¼Œè«‹æª¢æŸ¥æ‚¨çš„å¸³æˆ¶å®‰å…¨');
    
    // 3. å¼·åˆ¶é‡æ–°èªè­‰
    localStorage.removeItem('authToken');
    window.location.href = '/login';
  },
  
  handleDataBreach: () => {
    // 1. ç«‹å³æ¸…é™¤æœ¬åœ°è³‡æ–™
    localStorage.clear();
    sessionStorage.clear();
    
    // 2. é€šçŸ¥å¾Œç«¯
    apiClient.post('/security/breach').catch(() => {});
    
    // 3. é‡å®šå‘åˆ°å®‰å…¨é é¢
    window.location.href = '/security-notice';
  }
};
```

## ğŸ“š åƒè€ƒè³‡æº

- [OWASP Top 10 2021](mdc:https:/owasp.org/Top10)
- [OWASP Cheat Sheet Series](mdc:https:/cheatsheetseries.owasp.org)
- [Content Security Policy](mdc:https:/developer.mozilla.org/en-US/docs/Web/HTTP/CSP)
- [DOMPurify Documentation](mdc:https:/github.com/cure53/DOMPurify)
- [React Security Best Practices](mdc:https:/blog.logrocket.com/react-security-best-practices)

---

**å®‰å…¨æ˜¯ä¸€å€‹æŒçºŒçš„éç¨‹ï¼Œéœ€è¦åœ¨æ•´å€‹é–‹ç™¼ç”Ÿå‘½é€±æœŸä¸­æŒçºŒé—œæ³¨å’Œæ”¹é€²ã€‚**
